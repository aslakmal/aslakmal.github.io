<!DOCTYPE html>
<html>
<head><title>Admin Dashboard</title></head>
<body>
  <h2>License Manager</h2>
  <button id="genBtn">Generate New License</button>
  <hr>
  <div id="list">Loading licenses...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAbnUDbULQE5NW5uRiu9VU5QqP3reOOQH0",
  authDomain: "stable-synapse-241016.firebaseapp.com",
  databaseURL: "https://stable-synapse-241016-default-rtdb.firebaseio.com",
  projectId: "stable-synapse-241016",
  storageBucket: "stable-synapse-241016.firebasestorage.app",
  messagingSenderId: "311188310788",
  appId: "1:311188310788:web:888512a24236ba39c45e51",
  measurementId: "G-SY83EZT9J1"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. Generate License
    document.getElementById("genBtn").onclick = async () => {
      const key = Math.random().toString(36).substring(2, 10).toUpperCase();
      await set(ref(db, 'licenses/' + key), {
        active: true,
        devices: {} // Empty initially
      });
      console.log(key)
    };

    // 2. Real-time List of all licenses
    onValue(ref(db, 'licenses'), (snapshot) => {
      const data = snapshot.val();
      const listDiv = document.getElementById("list");
      listDiv.innerHTML = "";
      
      for (let key in data) {
        const deviceCount = data[key].devices ? Object.keys(data[key].devices).length : 0;
        listDiv.innerHTML += `
          <div style="border:1px solid #ccc; margin:10px; padding:10px;">
            <strong>${key}</strong> | Devices: ${deviceCount}/5 
            <button onclick="resetDevices('${key}')">Reset Devices</button>
            <button onclick="deleteKey('${key}')" style="color:red">Delete Key</button>
          </div>`;
      }
    });

    // Attach functions to window so buttons can find them
    window.resetDevices = (key) => remove(ref(db, `licenses/${key}/devices`));
    window.deleteKey = (key) => remove(ref(db, `licenses/${key}`));
  </script>
</body>
</html>
